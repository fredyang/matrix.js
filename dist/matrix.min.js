/*!
 * matrix.js JavaScript Library v0.2pre
 * http://semanticsworks.com
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Fri Jan 20 12:03:19 2012 -0500
 */
(function(a,b){function C(a){var b,c=s.promises(a);if(!c){b=A(a);if(!b)throw"There is no handler for resource type"+s.resourceType(a);c=b.load(a),s.promises(a,c)}c.preload||(c.refCount=c.refCount?c.refCount+1:1);return c}function B(a){var b=A(a);if(!b)return s(s.resourceType(a)+".handler").thenLoad(a);return C(a)}function A(a){return f[s.resourceType(a)]}function z(a){var b=a.replace(j,"");return b.split(i)}function y(a){var b=q.exec(a.toLowerCase());return b&&(b[1]!=r[1]||b[2]!=r[2]||(b[3]||(b[1]==="http:"?80:443))!=(r[3]||(r[1]==="http:"?80:443)))}function x(a,c,d){return function e(f,g){if(typeof f==="object"){for(var h in f)e(h,f[h]);return a}c&&(f=c(f));if(g!==b){d&&(g=d(g,f));return a[f]=g}if(arguments.length===1)return a[f];delete a[f]}}function w(a){var b,c=0,d;typeof a==="string"&&(a=z(a));for(c=0;c<a.length;c++)d=a[c],c===0?b=t(d):b=b.thenLoad(d);return u(b)}function v(b){var c=[],d,e=z(b);if(e.length===1)d=B(e[0]);else{for(var f=0;f<e.length;f++)c.push(B(e[f]));d=a.when.apply(a,c)}return u(d)}function u(b){var c=a.Deferred();b.thenLoad=function(){var a=k.call(arguments);b.done(function(){s.apply(null,a).done(function(a){c.resolve(a)})});return u(c.promise())},b.andLoad=function(){var b=p,c=s.apply(null,arguments);return u(a.when(c,b))};return b}function t(b,c){var d,e;if(typeof b==="string"){if(c){e=z(b);for(d=0;d<e.length;d++)d===0&&(s.depend(e[d])||s.depend(e[d],null)),d<e.length-1&&s.depend(e[d+1],e[d]);b=e[e.length-1]}return v(b)}if(a.isArray(b))return w(b);throw"resource parameter should be an array or string"}var c={},d={},e={},f={},g=document.createElement("a"),h=/^\s*\/\*\s*Depends\s*:\s*([\w\W]+?)\s*\*\//i,i=/,/,j=/\s+/g,k=[].slice,l=/\.(\w+)$/,m=/(.+)\.\w+$/,n,o=/^http[s]?:\/\/|^\//,p,q=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,r=q.exec(location.href.toLowerCase())||[],s=window.matrix=function(b,c,d){var e;typeof b!=="boolean"&&(d=c,c=b,b=!1),b=b&&!a.isReady,e=p=t(c,d),b&&(a.holdReady(!0),e.done(function(){a.ready(!0)}));return e};a.extend(s,{release:function(a,c){var d,e,f,g,h;typeof a==="string"&&(a=z(a));if(a.length===1){e=a[0],h=s.promises(e);if(!h||h.preload)return;g=A(e);if(c||--h.refCount===0)g.release&&g.release(e,c),s.promises(e,b),(f=s.depend(e))&&s.release(f,c)}else for(d=0;d<a.length;d++)s.release(a[d],c)},url:function(a,d){if(typeof a==="string"){var e=A(a);if(e.url)return e.url(a)}return c[a]||d!==b?n.apply(null,arguments):n(a,a)},parse:function(a,b){var c,d=A(a);d.parse?c=d.parse(a,b):(c=h.exec(b),c=c&&c[1]||null);return c}}),a.extend(s,{depend:function(a,c,d){if(typeof a==="object"){d=c;for(var f in a)a.hasOwnProperty(f)&&s.depend(f,a[f],d)}else if(c===b){if(arguments.length==1){var g=A(a);return g.depend?g.depend(a)+(e[a]||""):e[a]}delete e[a]}else e[a]=c,d&&s.reload(a)},reload:function(b){if(s.promises(b)){var c=a.extend({},d);s.release(b,!0);return s(b).done(function(){for(var a in c)d[a]&&c[a]&&(d[a].refCount=c[a].refCount)})}},loadResourceHandlers:function(b){s(a.map(z(b),function(a){return a+".handler"})+"")},resourceBaseUrl:"",matrixBaseUrl:"matrix/"}),a.extend(s,{addHandler:function(b,c,d){typeof c==="object"&&(d=c,c=null);return f[b]=a.extend({},f[c],d)},buildLoad:function(b,c,d){var e=function(b,e,f){y(e)?d(e).done(function(a){s.promises(b).parentDefer.resolve(a)}):a.get(e,null,null,"text").success(function(a){var d=c(b,e,a),g=f&&s.parse(b,a);if(g){var h=s.depend(b);s.depend(b,h?h+","+g:g),s(g).done(d)}else d()})};return function(c){var d,f=a.Deferred(),g=f.promise(),h=s.url(c),i=b(h);if(i){g.preload=!0,f.resolve();return g}g.parentDefer=f,d=s.depend(c),d?s(d).done(function(){e(c,h,!1)}):d===null?e(c,h,!1):e(c,h,!0);return g}}}),a.extend(s,{promises:x(d,function(a){var b=A(a),c=b&&b.promiseKey;return c?c(a):s.url(a)}),fullUrl:function(a){g.href=o.test(a)?a:s.resourceBaseUrl+a;return g.href},resourceType:function(a){return l.exec(a)[1]},resourceName:function(a){return m.exec(a)[1]},debug:function(){this._dependencies=e,this._urls=c,this._promises=d,this._handlers=f}}),n=x(c,b,s.fullUrl);var D=/\s*\/\*\s*release\s*:\s*([\w\W]+?)\s*\*\/\w*$/;s.addHandler("js",{load:s.buildLoad(function(b){return!!a("script").filter(function(){return this.src===b}).length},function(b,c,d){var e=s.promises(b),f=D.exec(d);f&&f[1]&&(e.release=new Function(f[1]));return function(){a.globalEval(d),e.parentDefer.resolve()}},a.getScript),release:function(a){var b=s.promises(a);b&&b.release&&b.release()}}),s.addHandler("css",{load:s.buildLoad(function(b){return!!a("link").filter(function(){return this.href===b&&a(this).attr("matrix")}).length},function(b,c){return function(){var d=s.promises(b);a("<link href='"+c+"' rel='stylesheet' type='text/css' matrix='1' />").appendTo("head"),setTimeout(function(){d.parentDefer.resolve()},1)}},function(b){a("<link href='"+b+"' rel='stylesheet' type='text/css' matrix='1' />").appendTo("head");var c=a.Deferred();setTimeout(function(){c.resolve()});return c.promise()}),release:function(b){var c=s.url(b);a("link").filter(function(){return this.href===c&&a(this).attr("matrix")}).remove()}}),s.addHandler("module",{load:function(b){var c=s.depend(b),d=a.Deferred();c?s(c).done(function(){d.resolve()}):d.resolve();return d.promise()},url:function(a){return a}}),s.addHandler("handler","js",{url:function(a){return s.resourceBaseUrl+s.matrixBaseUrl+"handle."+s.resourceName(a)+".js"}})})(jQuery);