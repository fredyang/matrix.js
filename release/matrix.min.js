/*!
 * matrix JavaScript Library v0.1
 * http://semanticsworks.com/p/matrix-library.html
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Wed Apr 27 14:38:19 2011 -0400
 */
(function(a,b){function u(b){var c=a.Deferred();b.load=function(){var a=k.call(arguments,0);b.done(function(){n.apply(null,a).done(function(){c.resolve()})});return u(c.promise())};return b}function t(a){var b,c=n.promises(a);c?c.preload||c.refCount++:(b=s(a),c=b.load(a),c.preload||(c.refCount=1),n.promises(a,c));return c}function s(b){var c=l.exec(b);c=c&&c[1],c||a.error("missing extension in reference, can't get handler");var d=f[c];d||a.error("handler has not been registered");return d}function r(a){var b,c=0,d,e;for(c=0;c<a.length;c++)e=a[c],c===0?b=n.load(e):b=b.load(e);return u(b)}function q(b){var c=[],d;b=p(b);if(b.length===1)d=t(b[0]);else{for(var e=0;e<b.length;e++)c.push(t(b[e]));d=a.when.apply(a,c)}return u(d)}function p(a){var b=a.replace(j,"");return b.split(i)}function o(a,c,d){return function e(f,g){if(typeof f==="object"){for(var h in f)e(h,f[h]);return a}c&&(f=c(f));if(g!==b){d&&(g=d(g,f));return a[f]=g}if(arguments.length===1)return a[f];delete a[f]}}var c={},d={},e={},f={},g=document.createElement("a"),h=/^\s*\/\*\s*Depends\s*:\s*([\w\W]+?)\s*\*\//i,i=/,/,j=/\s+/g,k=[].slice,l=/\.(\w+)$/,m,n=function(a,b){var c;typeof a==="string"?c=q(a):c=r(a);var d=b&&k.call(arguments,1);return d?c.done.apply(c,d):c};window.matrix=n,n.load=n,a.extend(n,{release:function(a){var c,d,e,f,g,h;typeof a==="string"&&(a=p(a));if(a.length===1){d=a[0],h=n.promises(d);if(!h)return;f=s(d),h.preload||(g=--h.refCount,g===0&&(f.release&&f.release(d),n.promises(d,b),(e=n.depend(d))&&n.release(e)))}else for(c=0;c<a.length;c++)n.release(a[c])},url:function(a,d){var e;if(typeof a==="string"){var f=s(a);if(f.url)return f.url(a)}typeof a!=="string"||c[a]||d!==b?e=k.call(arguments):(d=n.baseUrl+a,e=[a,d]);return m.apply(null,e)},parseDepends:function(a,b){var c=s(a);if(c.parseDepends)return c.parseDepends(b);var d=h.exec(b);return d&&d[1]||null}}),a.extend(n,{depend:function(a,c,d){if(typeof a==="object"){d=c;for(var f in a)a.hasOwnProperty(f)&&n.depend(f,a[f],d)}else{if(c!==b){var g=d&&n.promises(a);if(g){n.release(a,!0),e[a]=c;return n.load(a)}return e[a]=c}if(arguments.length==1)return e[a];delete e[a]}},promises:o(d,n.url),baseUrl:"",homeUrl:"matrix/",loadHandlers:function(a){typeof a==="string"&&(a=p(a));for(var b=0;b<a.length;b++)a[b]=n.homeUrl+"matrix."+a[b]+".js";a=a+"";return n(a)}}),a.extend(n,{addHandler:function(b,c,d){typeof c==="object"&&(d=c,c=null);return f[b]=a.extend({},f[c],d)},buildLoad:function(b,c){var d=function(b,d,e){a.get(d,null,null,"text").success(function(a){var f=c(b,d,a),g,h=e&&(g=n.parseDepends(b,a));h?(n.depend(b,g),n.load(g,f)):f()})};return function(c){var e,f=a.Deferred(),g=f.promise(),h=n.url(c),i=b(h);if(i){g.preload=!0,f.resolve();return g}g.defer=f,e=n.depend(c),e?n.load(e,function(){d(c,h,!1)}):e===null?d(c,h,!1):d(c,h,!0);return g}}}),a.extend(n,{fullUrl:function(a){g.href=a;return g.href},debug:function(){this._dependencies=e,this._urls=c,this._promises=d,this._handlers=f}}),m=o(c,b,n.fullUrl),n.addHandler("module",{load:function(b){var c=n.depend(b),d=a.Deferred();c?n.load(c,function(){d.resolve()}):d.resolve();return d.promise()},url:function(a){return a}});var v=/\s*\/\*\s*release\s*:\s*([\w\W]+?)\s*\*\/\w*$/;n.addHandler("js",{load:n.buildLoad(function(b){return!!a("script").filter(function(){return this.src===b}).length},function(b,c,d){var e=n.promises(b),f=v.exec(d);f&&f[1]&&(e.release=new Function(f[1]));return function(){a.globalEval(d),e.defer.resolve()}}),release:function(a){var b=n.promises(a);b&&b.release&&b.release()}}),n.addHandler("css",{load:n.buildLoad(function(b){return!!a("link").filter(function(){return this.href===b&&a(this).attr("matrix")}).length},function(b,c,d){var e=n.promises(b);return function(){a("<link href='"+c+"' rel='stylesheet' type='text/css' matrix='true' />").appendTo("head"),setTimeout(function(){e.defer.resolve()},1)}}),release:function(b){var c=n.url(b);a("link").filter(function(){return this.href===c&&a(this).attr("matrix")}).remove()}})})(jQuery);