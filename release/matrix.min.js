/*!
 * matrix JavaScript Library v0.2
 * http://semanticsworks.com/p/matrix-library.html
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Sat Apr 30 02:07:22 2011 -0400
 */
(function(a,b){function v(b){var c=a.Deferred();b.load=function(){var a=k.call(arguments,0);b.done(function(){o.apply(null,a).done(function(){c.resolve()})});return v(c.promise())};return b}function u(a){var b,c=o.promises(a);c?c.preload||c.refCount++:(b=t(a),c=b.load(a),c.preload||(c.refCount=1),o.promises(a,c));return c}function t(b){var c=f[o.resourceType(b)];c||a.error("handler has not been registered");return c}function s(a){var b,c=0,d,e;for(c=0;c<a.length;c++)e=a[c],c===0?b=o.load(e):b=b.load(e);return v(b)}function r(b){var c=[],d;b=q(b);if(b.length===1)d=u(b[0]);else{for(var e=0;e<b.length;e++)c.push(u(b[e]));d=a.when.apply(a,c)}return v(d)}function q(a){var b=a.replace(j,"");return b.split(i)}function p(a,c,d){return function e(f,g){if(typeof f==="object"){for(var h in f)e(h,f[h]);return a}c&&(f=c(f));if(g!==b){d&&(g=d(g,f));return a[f]=g}if(arguments.length===1)return a[f];delete a[f]}}var c={},d={},e={},f={},g=document.createElement("a"),h=/^\s*\/\*\s*Depends\s*:\s*([\w\W]+?)\s*\*\//i,i=/,/,j=/\s+/g,k=[].slice,l=/\.(\w+)$/,m=/(.+)\.\w+$/,n,o=function(a,b){var c,d,e,f,g;b&&typeof b!=="function"?(g=!0,f=k.call(arguments,2)):(g=!1,f=k.call(arguments,1));if(typeof a==="string")if(g){e=q(a);for(d=0;d<e.length;d++)d===0&&o.depend(e[d],null),d<e.length-1&&o.depend(e[d+1],e[d]);c=r(e[e.length-1])}else c=r(a);else c=s(a);return f?c.done.apply(c,f):c};window.matrix=o,o.load=o,a.extend(o,{release:function(a){var c,d,e,f,g,h;typeof a==="string"&&(a=q(a));if(a.length===1){d=a[0],h=o.promises(d);if(!h)return;f=t(d),h.preload||(g=--h.refCount,g===0&&(f.release&&f.release(d),o.promises(d,b),(e=o.depend(d))&&o.release(e)))}else for(c=0;c<a.length;c++)o.release(a[c])},url:function(a,d){var e;if(typeof a==="string"){var f=t(a);if(f.url)return f.url(a)}typeof a!=="string"||c[a]||d!==b?e=k.call(arguments):(d=o.baseUrl+a,e=[a,d]);return n.apply(null,e)},parseDepends:function(a,b){var c=t(a);if(c.parseDepends)return c.parseDepends(b);var d=h.exec(b);return d&&d[1]||null}}),a.extend(o,{depend:function(a,c,d){if(typeof a==="object"){d=c;for(var f in a)a.hasOwnProperty(f)&&o.depend(f,a[f],d)}else{if(c!==b){var g=d&&o.promises(a);if(g){o.release(a,!0),e[a]=c;return o.load(a)}return e[a]=c}if(arguments.length==1)return e[a];delete e[a]}},baseUrl:"",homeUrl:"matrix/",loadHandlers:function(a){typeof a==="string"&&(a=q(a));for(var b=0;b<a.length;b++)a[b]=o.homeUrl+"matrix."+a[b]+".js";a=a+"";return o(a)}}),a.extend(o,{addHandler:function(b,c,d){typeof c==="object"&&(d=c,c=null);return f[b]=a.extend({},f[c],d)},buildLoad:function(b,c){var d=function(b,d,e){a.get(d,null,null,"text").success(function(a){var f=c(b,d,a),g,h=e&&(g=o.parseDepends(b,a));h?(o.depend(b,g),o.load(g,f)):f()})};return function(c){var e,f=a.Deferred(),g=f.promise(),h=o.url(c),i=b(h);if(i){g.preload=!0,f.resolve();return g}g.defer=f,e=o.depend(c),e?o.load(e,function(){d(c,h,!1)}):e===null?d(c,h,!1):d(c,h,!0);return g}}}),a.extend(o,{promises:p(d,o.url),fullUrl:function(a){g.href=a;return g.href},resourceType:function(b){var c=l.exec(b);c=c&&c[1],c||a.error("missing resource type in resourceKey");return c},resourceName:function(a){var b=m.exec(a);return b&&b[1]},debug:function(){this._dependencies=e,this._urls=c,this._promises=d,this._handlers=f}}),n=p(c,b,o.fullUrl),o.addHandler("module",{load:function(b){var c=o.depend(b),d=a.Deferred();c?o.load(c,function(){d.resolve()}):d.resolve();return d.promise()},url:function(a){return a}});var w=/\s*\/\*\s*release\s*:\s*([\w\W]+?)\s*\*\/\w*$/;o.addHandler("js",{load:o.buildLoad(function(b){return!!a("script").filter(function(){return this.src===b}).length},function(b,c,d){var e=o.promises(b),f=w.exec(d);f&&f[1]&&(e.release=new Function(f[1]));return function(){a.globalEval(d),e.defer.resolve()}}),release:function(a){var b=o.promises(a);b&&b.release&&b.release()}}),o.addHandler("css",{load:o.buildLoad(function(b){return!!a("link").filter(function(){return this.href===b&&a(this).attr("matrix")}).length},function(b,c,d){var e=o.promises(b);return function(){a("<link href='"+c+"' rel='stylesheet' type='text/css' matrix='true' />").appendTo("head"),setTimeout(function(){e.defer.resolve()},1)}}),release:function(b){var c=o.url(b);a("link").filter(function(){return this.href===c&&a(this).attr("matrix")}).remove()}})})(jQuery);